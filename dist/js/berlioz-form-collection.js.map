{"version":3,"file":"berlioz-form-collection.js","sources":["../../src/js/berlioz-form-collection.js"],"sourcesContent":["import $ from 'jquery'\n\nconst BerliozCollection = (($) => {\n  /**\n   * Events.\n   */\n  const Event = {\n    ADD: 'add.collection.berlioz',\n    ADDED: 'added.collection.berlioz',\n    DELETE: 'delete.collection.berlioz',\n    DELETED: 'deleted.collection.berlioz',\n    MIN: 'min.collection.berlioz',\n    MAX: 'max.collection.berlioz',\n    // Selectors\n    CLICK_ADD: 'click.add.collection.berlioz',\n    CLICK_DELETE: 'click.delete.collection.berlioz'\n  }\n\n  /**\n   * Selectors.\n   */\n  const Selector = {\n    DATA_ADD: '[data-add=\"collection\"]',\n    DATA_DELETE: '[data-delete=\"collection\"]',\n    COLLECTION: '[data-collection]',\n    COLLECTION_KEY: '[data-collection-key]'\n  }\n\n  /**\n   * Collection class.\n   */\n  class Collection {\n    constructor(target) {\n      this.target = $(target)\n    }\n\n    addElement() {\n      // Count the total element count in the collection\n      let newCount = this._nbElements()\n      let newElement = $('<div data-collection-key=\"' + newCount + '\"></div>')\n      let prototypeString = this.target.data('prototype').replace(/___name___/g, newCount)\n\n      // Control maximum\n      if (this._controlMaximum()) {\n        return;\n      }\n\n      // ADD event\n      let eventAdd = $.Event(Event.ADD)\n      this.target.trigger(eventAdd)\n\n      if (!eventAdd.isPropagationStopped()) {\n        newElement.append($(prototypeString))\n        let lastElement = $(Selector.COLLECTION_KEY, this.target).last()\n        if (lastElement.length === 1) {\n          newElement.insertAfter(lastElement)\n        } else {\n          this.target.prepend(newElement)\n        }\n\n        // ADDED event\n        this.target.trigger(Event.ADDED)\n\n        // Control maximum\n        this._controlMaximum()\n      }\n    }\n\n    deleteElement(element) {\n      element = $(element)\n\n      // If the element doesn't have the key attribute, it may be a child element of the item, so we try to get\n      // the item base element from its parents\n      if (typeof element.data('collection-key') === 'undefined') {\n        element = element.parents(Selector.COLLECTION_KEY)\n      }\n\n      // If no element found!\n      if (element.length === 0) {\n        return;\n      }\n\n      // Control minimum\n      if (this._controlMinimum()) {\n        return;\n      }\n\n      // DELETE event\n      let eventDelete = $.Event(Event.DELETE)\n      this.target.trigger(eventDelete)\n\n      if (!eventDelete.isPropagationStopped()) {\n        element.remove()\n\n        // Update the indexes on each element\n        let collectionName = this.target.data('collection')\n        let collectionNameEscaped = Collection._escapeRegExp(this.target.data('collection'))\n        let collectionId = this.target.attr('id')\n\n        $(Selector.COLLECTION_KEY, this.target).each(function (index) {\n          $(this).attr('data-collection-key', index)\n\n          $('input, select, textarea, label', this).each(function () {\n            let idPattern = new RegExp(collectionId + '_\\\\d+')\n            let namePattern = new RegExp(collectionNameEscaped + '\\\\[\\\\d+')\n\n            if ($(this)[0].hasAttribute('for')) {\n              $(this).attr('for', $(this).attr('for').replace(idPattern, collectionId + '_' + index))\n            }\n\n            if ($(this)[0].hasAttribute('name')) {\n              $(this).attr('name', $(this).attr('name').replace(namePattern, collectionName + '[' + index))\n            }\n            if ($(this)[0].hasAttribute('id')) {\n              $(this).attr('id', $(this).attr('id').replace(idPattern, collectionId + '_' + index))\n            }\n          })\n        })\n\n        // DELETED event\n        this.target.trigger(Event.DELETED)\n\n        // Control minimum\n        this._controlMinimum()\n      }\n    }\n\n    _nbElements() {\n      return $(Selector.COLLECTION_KEY, this.target).length\n    }\n\n    _controlMinimum() {\n      let minElements = this.target.data('collectionMin') || 0\n\n      if (minElements >= this._nbElements()) {\n        this.target.trigger(Event.MIN)\n        return true\n      }\n\n      return false\n    }\n\n    _controlMaximum() {\n      let maxElements = this.target.data('collectionMax') || null\n\n      if (maxElements !== null && maxElements <= this._nbElements()) {\n        this.target.trigger(Event.MAX)\n        return true\n      }\n\n      return false\n    }\n\n    static _escapeRegExp(string) {\n      return string.replace(/[.*+?^${}()|[\\]\\\\]/g, '\\\\$&') // $& means the whole matched string\n    }\n\n    static _jQueryInterface(action, arg1) {\n      this.each(function () {\n        let collectionObj = $(this).data('collection-object')\n\n        if (!(typeof collectionObj === 'object' && collectionObj instanceof Collection)) {\n          $(this).data('collection-object', collectionObj = new Collection(this))\n        }\n\n        switch (action) {\n          case 'add':\n            collectionObj.addElement()\n            break\n          case 'delete':\n            collectionObj.deleteElement(arg1)\n            break\n        }\n      })\n    }\n  }\n\n  $.fn.berliozCollection = Collection._jQueryInterface\n  $.fn.berliozCollection.noConflict = function () {\n    return Collection._jQueryInterface\n  }\n\n  // Events\n  $(document)\n    .off(Event.CLICK_ADD, Selector.DATA_ADD)\n    .on(Event.CLICK_ADD,\n      Selector.DATA_ADD,\n      (event) => {\n        $(event.currentTarget)\n          .parents(Selector.COLLECTION)\n          .berliozCollection('add')\n      })\n    .off(Event.CLICK_DELETE, Selector.DATA_DELETE)\n    .on(Event.CLICK_DELETE,\n      Selector.DATA_DELETE,\n      (event) => {\n        $(event.currentTarget)\n          .parents(Selector.COLLECTION)\n          .berliozCollection('delete', $(event.currentTarget).parents(Selector.COLLECTION_KEY))\n      })\n})($)\n\nexport default BerliozCollection\n"],"names":["BerliozCollection","$","Event","ADD","ADDED","DELETE","DELETED","MIN","MAX","CLICK_ADD","CLICK_DELETE","Selector","DATA_ADD","DATA_DELETE","COLLECTION","COLLECTION_KEY","Collection","target","newCount","_nbElements","newElement","prototypeString","data","replace","_controlMaximum","eventAdd","trigger","isPropagationStopped","append","lastElement","last","length","insertAfter","prepend","element","parents","_controlMinimum","eventDelete","remove","collectionName","collectionNameEscaped","_escapeRegExp","collectionId","attr","each","index","idPattern","RegExp","namePattern","hasAttribute","minElements","maxElements","string","action","arg1","collectionObj","addElement","deleteElement","fn","berliozCollection","_jQueryInterface","noConflict","document","off","on","event","currentTarget"],"mappings":"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"}